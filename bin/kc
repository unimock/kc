#!/bin/bash

_help() {
  IAM=`basename $0`
  echo "#"
  echo "# usage: $IAM up|down|rm <domain>"
  echo "#"
  echo "# examples:"
  echo "#"
  echo "DOM=test"
  echo $IAM' up   $DOM       # start VM'
  echo $IAM' down $DOM       # shutdown VM and wait for shut off'
  echo $IAM' rm   $DOM       # undefine and remove VM and assigned images'

  echo "#"
  echo "# other usefull kc commands:"
  echo "#"
  echo "kc-tool mig|ls       # migration/list running VMs"
  echo "kc-backup <command>  # USB-HD backup/restore" 
  echo "kc-status gluster    # show gluster info and healing"
  echo "kc-sparsify <domain> # shutdown, sparsify images and start domian"
  echo "kc-install init      # initialize kc environment"
  echo "kc-syncxml           # sync libvirt domain definition files between kvm hosts"

  echo ""
}
#CURROPT=""
#while [ "$#" -gt 0 ]; do
#  case "$1" in
#    -*)  ; shift 1 ;;
#    --escape)  shift 2 ;;
#    --*)       shift 1 ;;
#    *)   CURROPT="$CURROPT \"$1\"" ; shift 1 ;;
#  esac
#done
#eval set -- $CURROPT
if [ "$1" = "" ] ; then
  _help
  exit 0
fi
if [[ "$1" == "up" && "$2" != "" ]] ; then
  DOM="$2"
  virsh start $DOM
  exit $?
fi

if [[ "$1" == "down" && "$2" != "" ]] ; then
  CMD="$1"
  DOM="$2"
  state=$( virsh domstate ${DOM} )
  if [[ "$state" != "shut off" ]] ; then
    virsh shutdown ${DOM}
    i=0
    # wait until system is down, timeout 120s
    while true ; do
      i=$(( i + 1 ))
      sleep 1
      s=$( virsh domstate ${DOM} )
      echo "  wait until system is down : i=$i <$s>"
      if [[ "$s" == "shut off" ]] ; then
        break ;
      fi
      if [ $i -ge 120 ] ; then
         echo "error wait for off!!!!"
         exit 1
      fi
    done
  fi
  exit 0
fi

if [[ "$1" == "rm" && "$2" != "" ]] ; then
  CMD="$1"
  DOM="$2"
  state=$(virsh domstate $DOM)
  if [ "$state" != "shut off" ] ; then
    virsh destroy $DOM
  fi
  virsh undefine $DOM --remove-all-storage --checkpoints-metadata --snapshots-metadata
  exit $?
fi 


